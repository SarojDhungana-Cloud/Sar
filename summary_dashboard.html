<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Summary – Custom Dashboard</title>

<!-- Plotly + DataTables + jQuery (CDN) -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.5/css/dataTables.dataTables.min.css"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.5/js/dataTables.min.js"></script>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans; margin: 20px; }
  .grid { display: grid; grid-template-columns: repeat(6, minmax(160px, 1fr)); gap: 12px; }
  .card { background: #fff; border: 1px solid #eaecef; border-radius: 12px; padding: 16px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
  label { font-size: 12px; color: #555; display:block; margin-bottom:6px; }
  input[type="date"], select { width: 100%; padding: 8px 10px; border:1px solid #dfe3e8; border-radius:8px; }
  button.primary { padding: 10px 14px; border: 0; border-radius: 10px; background: #2563eb; color: white; font-weight: 600; cursor: pointer; }
  button.primary:hover { background: #1d4ed8; }
  .chart { height: 480px; position: relative; }
  .toolbar { position:absolute; top:8px; right:8px; display:flex; gap:8px; z-index:5; }
  .toolbtn { background:#0f172a; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:12px; opacity:.9 }
  .toolbtn:hover { opacity:1 }
  .note { font-size: 12px; color: #666; white-space:pre-wrap; }
  .row { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
  .inline { display:flex; align-items:center; gap:8px; }

  /* Data Levels panel (visibility + value labels) */
  .panel { position:absolute; top:40px; right:8px; z-index:6; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; width:260px; box-shadow: 0 8px 24px rgba(0,0,0,.08); displ[...]  
  .panel h4 { margin:0 0 8px 0; font-size:13px; }
  .trace-list { max-height:160px; overflow:auto; border:1px solid #f1f5f9; border-radius:8px; padding:6px; margin:6px 0 10px; }
  .panel .inline { justify-content: space-between; }
</style>
</head>
<body>

<div class="card">
  <h1 style="margin:0 0 12px 0;">Summary – Custom Dashboard</h1>
  <div class="note">Data source: <code id="csvUrl"></code></div>
</div>

<div class="card">
  <h2 style="margin:0 8px 12px 0;">Filters</h2>
  <div class="row" style="margin-bottom:10px;">
    <div class="inline">
      <input type="radio" id="modeAD" name="dateMode" value="AD" checked>
      <label for="modeAD"><b>Use DATE (AD)</b></label>
    </div>
    <div class="inline">
      <input type="radio" id="modeBS" name="dateMode" value="BS" disabled>
      <label for="modeBS"><b>Use Nepali_Date (BS)</b></label>
    </div>
    <span class="note" id="nepAvail"></span>
  </div>

  <div class="grid" id="adControls">
    <div>
      <label>First_Date (AD)</label>
      <input type="date" id="firstDateAD" />
    </div>
    <div>
      <label>Second_Date (AD)</label>
      <input type="date" id="secondDateAD" />
    </div>
  </div>

  <div class="grid" id="bsControls" style="display:none;">
    <div>
      <label>First_Nepali_Date (BS)</label>
      <select id="firstDateBS"></select>
    </div>
    <div>
      <label>Second_Nepali_Date (BS)</label>
      <select id="secondDateBS"></select>
    </div>
  </div>

  <div class="grid" style="margin-top:10px;">
    <div>
      <label>Day_Name</label>
      <select id="dayName"></select>
    </div>
    <div>
      <label>Type</label>
      <select id="typeSel"></select>
    </div>
    <div>
      <label>Block1</label>
      <select id="blockStart"></select>
    </div>
    <div>
      <label>Blockn</label>
      <select id="blockEnd"></select>
    </div>
  </div>

  <div style="margin-top:14px;">
    <button id="generateBtn" class="primary">Generate</button>
    <span class="note" id="rowCount" style="margin-left:12px;"></span>
  </div>
</div>

<!-- CHART 1 -->
<div class="card">
  <h2 style="margin:0 0 12px 0;">Chart 1 — Block-wise</h2>
  <div id="chart" class="chart">
    <div class="toolbar">
      <button class="toolbtn" onclick="togglePanel('chart')">⚙️ Data levels</button>
      <button class="toolbtn" onclick="fs('chart')">⤢ Fullscreen</button>
    </div>
    <div id="panel-chart" class="panel">
      <h4>Series visibility</h4>
      <div id="traces-chart" class="trace-list"></div>
      <div class="inline">
        <label for="vals-chart">Show values</label>
        <input id="vals-chart" type="checkbox">
      </div>
    </div>
  </div>
  <div id="forecastNotes" class="note" style="margin-top:10px;"></div>
</div>

<!-- DATA TABLE -->
<div class="card">
  <h2 style="margin:0 0 12px 0;">Data</h2>
  <div id="tableWrap"></div>
</div>

<!-- CHART 2 (below table) -->
<div class="card" id="card2" style="display:none;">
  <h2 style="margin:0 0 12px 0;">Chart 2 — Day-series (block-averaged)</h2>
  <div id="chart2" class="chart">
    <div class="toolbar">
      <button class="toolbtn" onclick="togglePanel('chart2')">⚙️ Data levels</button>
      <button class="toolbtn" onclick="fs('chart2')">⤢ Fullscreen</button>
    </div>
    <div id="panel-chart2" class="panel">
      <h4>Series visibility</h4>
      <div id="traces-chart2" class="trace-list"></div>
      <div class="inline">
        <label for="vals-chart2">Show values</label>
        <input id="vals-chart2" type="checkbox">
      </div>
      <div id="vals-note-chart2" class="note" style="margin-top:6px;">(Only effective when points &lt; 100)</div>
    </div>
  </div>
</div>

<!-- CHART 3 (below table) -->
<div class="card" id="card3" style="display:none;">
  <h2 style="margin:0 0 12px 0;">Chart 3 — Weekday averages (Sun→Sat)</h2>
  <div id="chart3" class="chart">
    <div class="toolbar">
      <button class="toolbtn" onclick="togglePanel('chart3')">⚙️ Data levels</button>
      <button class="toolbtn" onclick="fs('chart3')">⤢ Fullscreen</button>
    </div>
    <div id="panel-chart3" class="panel">
      <h4>Series visibility</h4>
      <div id="traces-chart3" class="trace-list"></div>
      <div class="inline">
        <label for="vals-chart3">Show values</label>
        <input id="vals-chart3" type="checkbox">
      </div>
    </div>
  </div>
</div>

<script>
/* ======= Fullscreen & Panel helpers ======= */
function fs(id){
  const el = document.getElementById(id);
  if (!document.fullscreenElement) { el.requestFullscreen?.(); }
  else { document.exitFullscreen?.(); }
}
function togglePanel(chartId){
  const el = document.getElementById('panel-'+chartId);
  el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
}

/* ========= CSV loader (Supabase Storage) ========= */
const SUPABASE_BASE = "https://imloololrtufqywapowk.supabase.co/storage/v1/object/public/flat-data/summary";
const urlParams = new URLSearchParams(location.search);
const archiveDate = urlParams.get("date"); // YYYY-MM-DD
const CSV_URL = archiveDate ? `${SUPABASE_BASE}/archive/${archiveDate}.csv`
                            : `${SUPABASE_BASE}/latest/summary.csv`;
document.getElementById("csvUrl").textContent = CSV_URL;

/* tiny CSV parser */
function parseCSV(text) {
  const lines = text.replace(/\r/g,"").trim().split("\n");
  const headers = lines[0].split(",");
  const rows = lines.slice(1).map(line => {
    const parts = line.split(",");
    const obj = {};
    headers.forEach((h,i)=>obj[h]=parts[i]??""
    );
    return obj;
  });
  return { headers, rows };
}
function looksLikeBlock(h) { return /^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}$/.test(h); }

async function loadPayload() {
  const resp = await fetch(CSV_URL, { cache: "no-store" });
  if (!resp.ok) throw new Error("Failed to load CSV: "+resp.status);
  const csv = await resp.text();
  const { headers, rows } = parseCSV(csv);

  const DATE="DATE", DAY="DAY_NAME", TYPE="TYPE", NEP="NEPALI_DATE";
  const blockCols = headers.filter(looksLikeBlock);

  const transformed = rows.map(r => {
    const o = { _DATE:r[DATE], _DAY:r[DAY], _TYPE:r[TYPE], _NEP:r[NEP] };
    blockCols.forEach(b => o[b] = r[b]==="" ? "" : Number(r[b]));
    return o;
  });

  const days = Array.from(new Set(transformed.map(r => r._DAY).filter(Boolean))).sort();
  const typesPresent = new Set(transformed.map(r => String(r._TYPE||""
  ).toUpperCase()));
  const typeOptions = ["All"].concat(["DAM","RTM"].filter(t => typesPresent.has(t)));
  const dayOptions  = ["All"].concat(days);

  const adDates = transformed.map(r => r._DATE).filter(Boolean).sort();
  const dmin = adDates[0] || ""; const dmax = adDates[adDates.length-1] || "";
  const nepDates = Array.from(new Set(transformed.map(r => r._NEP).filter(Boolean))).sort();

  return {
    rows: transformed,
    block_cols: blockCols,
    has_nepali: true,
    nep_col: "_NEP",
    nep_dates: nepDates,
    default_nep_first: nepDates[0] || "",
    default_nep_second: nepDates[nepDates.length-1] || "",
    day_options: dayOptions,
    type_options: typeOptions,
    default_first_ad: dmin,
    default_second_ad: dmax,
    csv_url: CSV_URL,
    default_block1: "00:00-00:15",
    default_blockn: "23:45-24:00",
    col_names: { DATE_AD:"_DATE", DAY:"_DAY", TYPE:"_TYPE", NEPALI: "_NEP" }
  };
}

/* ========= Dashboard + Forecast + Extra Charts ========= */
(async function () {
  const payload = await loadPayload();
  const rows = payload.rows;
  const blocks = payload.block_cols.slice();
  const hasNepali = payload.has_nepali;
  const NEP_COL = payload.nep_col || "";
  const nepDates = payload.nep_dates || [];
  const DATE = payload.col_names["DATE_AD"];
  const DAY  = payload.col_names["DAY"];
  const TYPE = payload.col_names["TYPE"];
  const NEP  = payload.col_names["NEPALI"];

  // controls
  const modeAD  = document.getElementById('modeAD');
  const modeBS  = document.getElementById('modeBS');
  const adWrap  = document.getElementById('adControls');
  const bsWrap  = document.getElementById('bsControls');
  const fAD     = document.getElementById('firstDateAD');
  const sAD     = document.getElementById('secondDateAD');
  const fBS     = document.getElementById('firstDateBS');
  const sBS     = document.getElementById('secondDateBS');
  const daySel  = document.getElementById('dayName');
  const typeSel = document.getElementById('typeSel');
  const b1Sel   = document.getElementById('blockStart');
  const bnSel   = document.getElementById('blockEnd');

  if (hasNepali && NEP_COL) { modeBS.disabled = false; document.getElementById('nepAvail').textContent = ""; }
  else { modeBS.disabled = true; document.getElementById('nepAvail').textContent = "(Nepali_Date not found in CSV)"; }

  fAD.value = payload.default_first_ad || "";
  sAD.value = payload.default_second_ad || "";

  function populateBS(selectEl, values) {
    selectEl.innerHTML = "";
    values.forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; selectEl.appendChild(o);
    });
  }
  populateBS(fBS, nepDates);
  populateBS(sBS, nepDates);
  if (nepDates.length) { fBS.value = payload.default_nep_first || nepDates[0]; sBS.value = payload.default_nep_second || nepDates[nepDates.length-1]; }

  function refreshMode(){ adWrap.style.display = modeAD.checked ? "" : "none"; bsWrap.style.display = modeAD.checked ? "none" : ""; }
  modeAD.addEventListener('change', refreshMode);
  modeBS.addEventListener('change', refreshMode);
  refreshMode();

  (payload.day_options || ["All"]).forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; daySel.appendChild(o); });
  (payload.type_options || ["All","DAM","RTM"]).forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; typeSel.appendChild(o); });
  blocks.forEach(v => { const o1=document.createElement('option'); o1.value=v; o1.textContent=v; b1Sel.appendChild(o1);
                        const o2=document.createElement('option'); o2.value=v; o2.textContent=v; bnSel.appendChild(o2); });
  daySel.value="All"; typeSel.value="All";
  b1Sel.value = payload.default_block1 || blocks[0];
  bnSel.value = payload.default_blockn || blocks[blocks.length-1];

  function num(v){ if (v===null || v===undefined || v==="") return null; const n = Number(String(v).replace(/[, ]/g,'')); return Number.isFinite(n)? n : null; }

  // filters
  function filterRowsBase() {
    const useBS = modeBS.checked && hasNepali && NEP_COL;
    const dateField = useBS ? NEP_COL : DATE;
    const lo = (useBS ? fBS.value : fAD.value) || "";
    const hi = (useBS ? sBS.value : sAD.value) || "";
    const day = (daySel.value||"All").toLowerCase();
    const typ = (typeSel.value||"All").toUpperCase();

    const filtered = rows.filter(r => {
      const d = (r[dateField]||"").trim();
      const dn = (r[DAY]||"").trim().toLowerCase();
      const tp = (r[TYPE]||"").toUpperCase();
      if (!(d && (!lo || d>=lo) && (!hi || d<=hi))) return false;
      if (day !== "all" && dn !== day) return false;
      if (typ !== "ALL" && !(tp.includes("_"+typ) || tp === typ)) return false;
      return true;
    });
    return { filtered, dateField, lo, hi, useBS };
  }
  function selectedBlockSpan(){
    const start = b1Sel.value, end = bnSel.value;
    const i1 = blocks.indexOf(start), i2 = blocks.indexOf(end);
    if (i1<0 || i2<0) return [];
    const a = Math.min(i1,i2), b = Math.max(i1,i2);
    return blocks.slice(a,b+1);
  }

  // helpers
  function orderByDate(arr){ return arr.slice().sort((a,b)=> String(a[DATE]).localeCompare(String(b[DATE]))); }
  function rowsByType(type){ return rows.filter(r => String(r[TYPE]||""
  ).toUpperCase() === type); }
  function maxDateAD(){ const ds=rows.map(r=>r[DATE]).filter(Boolean).sort(); return ds[ds.length-1] || ""; }
  function dayNameOf(iso){ const d = new Date(iso+"T00:00:00"); return d.toLocaleDateString("en-US",{weekday:"long"}); }
  function meanBlock(rowsArr, blk){ let s=0,n=0; rowsArr.forEach(r=>{ const v=num(r[blk]); if(v!==null){ s+=v;n++; }}); return n? s/n : null; }
  function avgOverBlocksOfRow(r, span){ let s=0,n=0; span.forEach(c=>{ const v=num(r[c]); if(v!==null){ s+=v;n++; }}); return n? s/n : null; }
  function meanArray(arr){ const zs=arr.filter(v=>v!=null && Number.isFinite(v)); if(!zs.length) return null; return zs.reduce((a,b)=>a+b,0)/zs.length; }

  function lastNDays(type, beforeDate, n){ const arr=orderByDate(rowsByType(type)).filter(r=>r[DATE] < beforeDate); return arr.slice(-n); }
  function prevNDaysWindow(type,beforeDate,n,offsetN){ const arr=orderByDate(rowsByType(type)).filter(r=>r[DATE] < beforeDate); const end=arr.length - offsetN; const start=Math.max(0,end-n); retu[...]