<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Energy Pivot Dashboard</title>

<link rel="stylesheet" href="https://cdn.webdatarocks.com/latest/webdatarocks.min.css"/>
<script src="https://cdn.webdatarocks.com/latest/webdatarocks.js"></script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://cdn.webdatarocks.com/latest/webdatarocks.highcharts.js"></script>

<style>
  :root { --bg:#0b1020; --card:#0f1530; --text:#e9edf1; --muted:#94a3b8; --excel-grid:#f3f6fb; --excel-lines:#e6ecf5; }
  html,body { height:100%; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* === WIDEN PAGE TO FULL WIDTH === */
  .wrap {
    width:100vw;           /* occupy the full viewport width */
    max-width:none;        /* remove any max width cap */
    margin:16px 0;         /* minimal vertical margin */
    padding:0 8px;         /* small breathing room on the edges */
    box-sizing:border-box; /* include padding in width */
  }

  .card { background:var(--card); border-radius:14px; padding:14px 16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .row { display:flex; flex-wrap:wrap; gap:16px; }
  .col { flex:1; min-width:220px; }
  .muted { color:var(--muted); }
  .btn { background:#1b3cb3; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; }
  .btn.secondary { background:#2b365e; }
  .fieldset { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:10px; }
  .field { display:flex; flex-direction:column; gap:6px; }
  .label { font-size:12px; color:var(--muted); }
  select, input[type="text"], input[type="number"] { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #1e2a5a; background:#0c1230; color:#e9edf1; }

  /* Use one full-width column (right panel removed earlier) */
  .main { display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px; }

  #wdr {
    background:
      linear-gradient(var(--excel-lines) 1px, transparent 1px) 0 0/100% 22px,
      linear-gradient(90deg, var(--excel-lines) 1px, transparent 1px) 0 0/120px 100%,
      var(--excel-grid);
    border-radius:12px;
  }

  /* Chart title bar */
  #chartTitleBar { display:flex; align-items:flex-end; gap:12px; margin-top:12px; flex-wrap:wrap; }
  #chartTitleDisplay { font-weight:700; margin-top:8px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="align-items:center;">
    <h1 style="margin:0; font-size:22px;">Energy Pivot Dashboard</h1>
    <div class="muted" style="margin-left:auto; font-size:12px;">Live from JSONBin</div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="row">
      <div class="col">
        <div class="label">Timeframe</div>
        <select id="tfMode">
          <option value="day" selected>Day wise</option>
          <option value="week">Week wise</option>
          <option value="month">Month wise</option>
          <option value="year">Year wise</option>
        </select>
      </div>

      <!-- Day -->
      <div class="col tf tf-day">
        <div class="fieldset">
          <div class="field"><div class="label">Start Year</div><select id="dStartY"></select></div>
          <div class="field"><div class="label">Start Month</div><select id="dStartM"></select></div>
          <div class="field"><div class="label">Start Day</div><select id="dStartD"></select></div>
          <div class="field"><div class="label">End Year</div><select id="dEndY"></select></div>
          <div class="field"><div class="label">End Month</div><select id="dEndM"></select></div>
          <div class="field"><div class="label">End Day</div><select id="dEndD"></select></div>
        </div>
      </div>

      <!-- Hidden (kept for completeness) -->
      <div class="col tf tf-week" style="display:none;">
        <div class="fieldset">
          <div class="field"><div class="label">Start Year</div><select id="wStartY"></select></div>
          <div class="field"><div class="label">Start Month</div><select id="wStartM"></select></div>
          <div class="field"><div class="label">Start Phase</div><select id="wStartP"></select></div>
          <div class="field"><div class="label">End Year</div><select id="wEndY"></select></div>
          <div class="field"><div class="label">End Month</div><select id="wEndM"></select></div>
          <div class="field"><div class="label">End Phase</div><select id="wEndP"></select></div>
        </div>
      </div>

      <div class="col tf tf-month" style="display:none;">
        <div class="fieldset">
          <div class="field"><div class="label">Start Year</div><select id="mStartY"></select></div>
          <div class="field"><div class="label">Start Month</div><select id="mStartM"></select></div>
          <div class="field"><div class="label">End Year</div><select id="mEndY"></select></div>
          <div class="field"><div class="label">End Month</div><select id="mEndM"></select></div>
        </div>
      </div>

      <div class="col tf tf-year" style="display:none;">
        <div class="fieldset">
          <div class="field"><div class="label">Start Year</div><select id="yStartY"></select></div>
          <div class="field"><div class="label">End Year</div><select id="yEndY"></select></div>
        </div>
      </div>

      <div class="col" style="display:flex; gap:10px; align-items:end;">
        <button id="btnApply" class="btn">Apply Timeframe</button>
        <button id="btnExcel" class="btn secondary">Download Excel</button>
        <button id="btnPDF" class="btn secondary">Download PDF</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <div id="wdr" style="height:520px;"></div>

      <!-- Chart controls -->
      <div id="chartTitleBar">
        <div class="col" style="flex:1; min-width:260px;">
          <div class="label">Chart title (leave blank to auto-generate)</div>
          <input id="chartTitleInput" type="text" placeholder="Custom chart title"/>
        </div>
        <div class="col" style="max-width:220px;">
          <div class="label">Chart type</div>
          <select id="chartType">
            <option value="column" selected>Column</option>
            <option value="column-stacked">Stacked Column</option>
            <option value="line">Line</option>
            <option value="area">Area</option>
            <option value="bar">Bar</option>
          </select>
        </div>
        <div class="col" style="max-width:160px;">
          <div class="label">&nbsp;</div>
          <label style="font-size:13px; display:flex; align-items:center; gap:8px;">
            <input id="toggleLabels" type="checkbox" style="width:16px; height:16px;"/> Show data labels
          </label>
        </div>
        <div class="col" style="max-width:140px;">
          <div class="label">Title size (px)</div>
          <input id="chartTitleSize" type="number" min="10" max="40" step="1" value="16"/>
        </div>
        <div class="col" style="max-width:140px; display:flex; align-items:flex-end;">
          <button id="btnApplyChart" class="btn secondary" style="width:100%;">Apply</button>
        </div>
      </div>

      <div id="chartTitleDisplay"></div>
      <div id="chart" style="height:420px; margin-top:6px;"></div>
    </div>
  </div>
</div>

<script>
const DATA_URL = "https://api.jsonbin.io/v3/b/68d62f76ae596e708ffc3c1a/latest";

const COL_DATE   = "Traded Date";
const COL_LINE   = "Line";
const COL_ENERGY = "Traded Energy";
const COL_BILL   = "Net Bill in NPR";

/* Independent fields for date parts */
const COL_DAY   = "Traded Date.Day";
const COL_MONTH = "Traded Date.Month";
const COL_YEAR  = "Traded Date.Year";

let pivot=null, allRows=[], enrichedRows=[], chartObj=null;
let DATE_KEY="", ENERGY_KEY="", BILL_KEY="";

/* ------------ helpers ------------ */
function ciFindKey(obj,wanted){
  const keys = Object.keys(obj||{});
  const exact = keys.find(k => k.toLowerCase() === wanted.toLowerCase());
  if (exact) return exact;
  return keys.find(k => k.toLowerCase().includes(wanted.toLowerCase())) || wanted;
}
function parseDateFlexible(v){
  if(v==null) return null;
  if(v instanceof Date && !isNaN(v)) return new Date(v.getFullYear(), v.getMonth(), v.getDate());
  if(typeof v==="number" || (/^\d+$/.test(String(v).trim()))){
    const n = Number(v);
    if(n > 20000 && n < 70000){
      const base = new Date(Date.UTC(1899,11,30));
      const d = new Date(base.getTime() + n*86400000);
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    const d = new Date(n);
    return isNaN(d)?null:new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  const s = String(v).trim();
  let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(m){ const y=+m[1], mo=+m[2]-1, d=+m[3]; const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  m = s.match(/^(\d{4})[\/](\d{1,2})[\/](\d{1,2})$/);
  if(m){ const y=+m[1], mo=+m[2]-1, d=+m[3]; const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  m = s.match(/^(\d{1,2})[\/](\d{1,2})[\/](\d{4})$/);
  if(m){ const d=+m[1], mo=+m[2]-1, y=+m[3]; const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
  if(m){ const d=+m[1], mo=+m[2]-1, y=+m[3]; const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  m = s.match(/^(\d{1,2})[\/](\d{1,2})[\/](\d{2})$/);
  if(m){ const d=+m[1], mo=+m[2]-1, yy=+m[3]; const y = yy<=68 ? 2000+yy : 1900+yy; const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{2})$/);
  if(m){ const d=+m[1], mo=+m[2]-1, yy=+m[3]; const y = yy<=68 ? 2000+yy : 1900+yy; const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  m = s.match(/^(\d{1,2})[-\s]([A-Za-z]{3})[-\s](\d{4})$/);
  if(m){
    const monMap={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    const d=+m[1], mo=monMap[m[2].toLowerCase()], y=+m[3];
    if(mo!=null){ const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  }
  m = s.match(/^([A-Za-z]{3})\s+(\d{1,2}),\s*(\d{4})$/);
  if(m){
    const monMap={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    const mo=monMap[m[1].toLowerCase()], d=+m[2], y=+m[3];
    if(mo!=null){ const dt=new Date(y,mo,d); return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
  }
  const dt = new Date(s);
  return isNaN(dt) ? null : new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
}
function toDateOnly(v){ const d=parseDateFlexible(v); return d && !isNaN(d) ? d : null; }
function monthDays(y,m){ return new Date(y, m+1, 0).getDate(); }
function fillSelect(sel, arr, map=(x)=>x){ sel.innerHTML=""; arr.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=map(v); sel.appendChild(o); }); }
function maxDate(rows,key){ let m=null; rows.forEach(r=>{ const d=toDateOnly(r[key]); if(d && (!m || d>m)) m=d; }); return m; }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return new Date(x.getFullYear(),x.getMonth(),x.getDate()); }
const fmtDate = d => d ? d.toLocaleDateString(undefined,{day:"numeric",month:"short",year:"numeric"}) : "";

/* --------- Enrich rows with independent date parts (Day/Month/Year) --------- */
function enrichWithDateParts(rows, dateKey){
  return rows.map(r=>{
    const copy = Object.assign({}, r);
    const d = toDateOnly(r[dateKey]);
    if (d){
      copy[COL_DAY]   = d.getDate();
      copy[COL_MONTH] = new Date(2000,d.getMonth(),1).toLocaleString(undefined,{month:"long"});
      copy[COL_YEAR]  = d.getFullYear();
    } else {
      copy[COL_DAY]   = null;
      copy[COL_MONTH] = null;
      copy[COL_YEAR]  = null;
    }
    return copy;
  });
}

/* ---------- DEFAULT FIELDS ---------- */
function buildDefaultSlice(){
  return {
    reportFilters: [{ uniqueName: COL_LINE }],
    rows:         [{ uniqueName: COL_DAY, sort:"asc" }],
    columns:      [{ uniqueName: "Measures" }],
    measures: [
      { uniqueName: BILL_KEY,   aggregation:"sum", caption:"Sum of " + BILL_KEY },
      { uniqueName: ENERGY_KEY, aggregation:"sum", caption:"Sum of " + ENERGY_KEY }
    ]
  };
}

/* title helpers */
function selectedRangeFromPickers(){
  const from=new Date(+dStartY.value,+dStartM.value,+dStartD.value);
  const to=new Date(+dEndY.value,+dEndM.value,+dEndD.value);
  return {min:from,max:to};
}
function defaultTitle(){
  const r = selectedRangeFromPickers();
  return `Sum of Net Bill in NPR & Sum Of Traded Energy by Day from ${fmtDate(r.min)} to ${fmtDate(r.max)}`;
}
function updateTitle(){
  const s = (document.getElementById("chartTitleInput").value || "").trim();
  const t = s || defaultTitle();
  const el = document.getElementById("chartTitleDisplay");
  el.textContent = t;
  el.style.fontSize = (document.getElementById("chartTitleSize").value || 16) + "px";
}

/* filtering by pickers */
function filterByPickers(){
  const r = selectedRangeFromPickers();
  const inR=(d,a,b)=>d>=a && d<=b;
  return enrichedRows.filter(row=>{
    const d=toDateOnly(row[DATE_KEY]);
    return d && inR(d,r.min,r.max);
  });
}
function applyTimeframeAndRefresh(){
  const filtered = filterByPickers();
  const rpt = pivot.getReport();
  rpt.dataSource = { data: filtered.length ? filtered : enrichedRows };
  pivot.setReport(rpt);
}

/* chart */
function renderChart(){
  if(!pivot) return;
  updateTitle();
  const showLabels = document.getElementById("toggleLabels").checked;
  const type = document.getElementById("chartType").value;

  pivot.highcharts.getData({ type }, function(cfg){
    const leftTitle  = "Sum of " + BILL_KEY;
    const rightTitle = "Sum of " + ENERGY_KEY;
    cfg.yAxis=[{title:{text:leftTitle}},{title:{text:rightTitle},opposite:true}];
    (cfg.series||[]).forEach(s=>{
      const name=(s.name||"").toLowerCase();
      if(name.includes(ENERGY_KEY.toLowerCase())) s.yAxis=1; else s.yAxis=0;
      if(showLabels) s.dataLabels={enabled:true};
    });
    cfg.title={ text:"" };
    if(chartObj) chartObj.destroy();
    chartObj = Highcharts.chart("chart", cfg);
  }, function(err){ console.error(err); });
}
const rerenderChart = (fn=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(fn,120); }; })(renderChart);

/* pickers setup for last 7 days */
function setupPickersTo(from,to){
  const monthLen = (y,m)=>Array.from({length:monthDays(y,m)},(_,i)=>i+1);
  dStartY.value=from.getFullYear(); dStartM.value=from.getMonth();
  fillSelect(dStartD, monthLen(from.getFullYear(), from.getMonth())); dStartD.value=from.getDate();
  dEndY.value=to.getFullYear(); dEndM.value=to.getMonth();
  fillSelect(dEndD, monthLen(to.getFullYear(), to.getMonth())); dEndD.value=to.getDate();
}

(async function init(){
  try{
    const r = await fetch(DATA_URL, { cache:"no-store" });
    if(!r.ok) throw new Error("Failed to fetch JSON ("+r.status+")");
    const payload = await r.json();
    allRows = (payload && payload.record && Array.isArray(payload.record.rows)) ? payload.record.rows : [];
    if(!allRows.length) throw new Error("No flat rows in JSONBin");

    DATE_KEY   = ciFindKey(allRows[0], COL_DATE);
    ENERGY_KEY = ciFindKey(allRows[0], COL_ENERGY);
    BILL_KEY   = ciFindKey(allRows[0], COL_BILL);

    // Enrich with independent Day/Month/Year fields
    enrichedRows = enrichWithDateParts(allRows, DATE_KEY);

    // default datasource: last 7 days
    const last = maxDate(enrichedRows, DATE_KEY);
    const from = last ? addDays(last, -6) : null;
    const viewRows = (from && last)
      ? enrichedRows.filter(r=>{ const d=toDateOnly(r[DATE_KEY]); return d && d>=from && d<=last; })
      : enrichedRows.slice();

    pivot = new WebDataRocks({
      container:"#wdr",
      height:520,
      toolbar:true,
      report:{
        dataSource:{ data:viewRows },
        slice: buildDefaultSlice(),
        options:{ grid:{ type:"classic", showTotals:"rows", showGrandTotals:"rows", showHeaders:true } }
      },
      reportcomplete: function(){
        pivot.off("reportcomplete");
        pivot.on("aftergriddraw", rerenderChart);
        rerenderChart();
      },
      reportchange: function(){ rerenderChart(); }
    });

    // init pickers lists (years + months) and set to last-7 range
    const years=[...new Set(enrichedRows.map(r=>toDateOnly(r[DATE_KEY])?.getFullYear()).filter(Boolean))].sort((a,b)=>a-b);
    ["dStartY","dEndY"].forEach(id=>fillSelect(document.getElementById(id), years));
    const monthsAll = Array.from({length:12},(_,i)=>i);
    ["dStartM","dEndM"].forEach(id=>fillSelect(document.getElementById(id), monthsAll, i => new Date(2000,i,1).toLocaleString(undefined,{month:"long"})));
    if (from && last) setupPickersTo(from,last);

    // wire controls
    btnApply.onclick = () => { applyTimeframeAndRefresh(); };
    btnExcel.onclick = () => pivot.exportTo("excel", { filename:"pivot_table" });
    btnPDF.onclick   = () => { if(chartObj) chartObj.exportChart({ type:"application/pdf", filename:"pivot_chart" }); };
    btnApplyChart.onclick = () => rerenderChart();
    chartTitleSize.onchange = () => updateTitle();

  }catch(e){
    alert(e.message || e);
    console.error(e);
  }
})();
</script>
</body>
</html>
